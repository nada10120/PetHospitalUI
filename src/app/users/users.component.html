<div class="container mt-4">
  <h2>Users Management</h2>
  <button class="btn btn-primary mb-3" (click)="openCreateForm()">Add New User</button>

  <div *ngIf="successMessage" class="alert alert-success" role="alert">
    {{ successMessage }}
  </div>
  <div *ngIf="errorMessage" class="alert alert-danger" role="alert">
    {{ errorMessage }}
  </div>

  <table class="table table-bordered">
    <thead>
      <tr>
        <th>Email</th>
        <th>Username</th>
        <th>Address</th>
        <th>Role</th>
        <th>Profile Picture</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let user of users">
        <td>{{ user.email }}</td>
        <td>{{ user.userName }}</td>
        <td>{{ user.address }}</td>
        <td>{{ user.role }}</td>
        <td>
          <img [src]="getProfilePictureUrl(user.profilePicture)" alt="Profile Picture" width="50" height="50" (error)="handleImageError($event)" />
        </td>
        <td>
          <button class="btn btn-sm btn-warning me-2" (click)="openEditForm(user)">Edit</button>
          <button class="btn btn-sm btn-danger" (click)="deleteUser(user.id)">Delete</button>
        </td>
      </tr>
    </tbody>
  </table>

  <div *ngIf="isFormVisible" class="card mt-4">
    <div class="card-header">
      {{ isEditMode ? 'Edit User' : 'Create User' }}
    </div>
    <div class="card-body">
      <form #userForm="ngForm" (ngSubmit)="onSubmit()">
        <div class="mb-3">
          <label for="email" class="form-label">Email</label>
          <input type="email" class="form-control" id="email" [(ngModel)]="formData.email" name="email" required email #email="ngModel" autocomplete="email" />
          <div *ngIf="email.invalid && (email.dirty || email.touched)" class="text-danger">
            <div *ngIf="email.errors?.['required']">Email is required.</div>
            <div *ngIf="email.errors?.['email']">Invalid email format.</div>
          </div>
        </div>
        <div class="mb-3" *ngIf="!isEditMode">
          <label for="password" class="form-label">Password</label>
          <input type="password" class="form-control" id="password" [(ngModel)]="formData.password" name="password" minlength="8" #password="ngModel" required autocomplete="new-password" />
          <div *ngIf="password.invalid && (password.dirty || password.touched)" class="text-danger">
            <div *ngIf="password.errors?.['required']">Password is required.</div>
            <div *ngIf="password.errors?.['minlength']">Password must be at least 8 characters.</div>
          </div>
        </div>
        <div class="mb-3" *ngIf="!isEditMode">
          <label for="confirmPassword" class="form-label">Confirm Password</label>
          <input type="password" class="form-control" id="confirmPassword" [(ngModel)]="formData.confirmPassword" name="confirmPassword" #confirmPassword="ngModel" required autocomplete="new-password" />
          <div *ngIf="confirmPassword.invalid && (confirmPassword.dirty || confirmPassword.touched)" class="text-danger">
            <div *ngIf="confirmPassword.errors?.['required']">Confirm Password is required.</div>
          </div>
        </div>
        <div class="mb-3">
          <label for="userName" class="form-label">Username</label>
          <input type="text" class="form-control" id="userName" [(ngModel)]="formData.userName" name="userName" required #userName="ngModel" autocomplete="username" />
          <div *ngIf="userName.invalid && (userName.dirty || userName.touched)" class="text-danger">
            <div *ngIf="userName.errors?.['required']">Username is required.</div>
          </div>
        </div>
        <div class="mb-3">
          <label for="address" class="form-label">Address</label>
          <input type="text" class="form-control" id="address" [(ngModel)]="formData.address" name="address" autocomplete="street-address" />
        </div>
        <div class="mb-3">
          <label for="role" class="form-label">Role</label>
          <select class="form-control" id="role" [(ngModel)]="formData.role" name="role" (change)="onRoleChange()" required #role="ngModel" autocomplete="off">
            <option value="">Select Role</option>
            <option value="SuperAdmin">SuperAdmin</option>
            <option value="Admin">Admin</option>
            <option value="Vet">Vet</option>
            <option value="Client">Client</option>
          </select>
          <div *ngIf="role.invalid && (role.dirty || role.touched)" class="text-danger">
            <div *ngIf="role.errors?.['required']">Role is required.</div>
          </div>
        </div>
        <div class="mb-3" *ngIf="formData.role === 'Vet'">
          <label for="specialization" class="form-label">Specialization</label>
          <input type="text" class="form-control" id="specialization" [(ngModel)]="formData.specialization" name="specialization" autocomplete="off" />
        </div>
        <div class="mb-3" *ngIf="formData.role === 'Vet'">
          <label for="availabilitySchedule" class="form-label">Availability Schedule</label>
          <input type="text" class="form-control" id="availabilitySchedule" [(ngModel)]="formData.availabilitySchedule" name="availabilitySchedule" autocomplete="off" />
        </div>
        <div class="mb-3">
          <label for="profilePicture" class="form-label">Profile Picture</label>
          <input type="file" class="form-control" id="profilePicture" (change)="onFileSelected($event)" name="profilePicture" accept="image/*" />
          <div *ngIf="isEditMode && formData.profilePicture" class="mt-2">
            <p>Current Profile Picture:</p>
            <img [src]="getProfilePictureUrl(formData.profilePicture)" alt="Current Profile Picture" width="100" height="100" (error)="handleImageError($event)" />
          </div>
        </div>
        <button type="submit" class="btn btn-primary" [disabled]="!userForm.valid || (!isEditMode && formData.password !== formData.confirmPassword)">{{ isEditMode ? 'Update' : 'Create' }}</button>
        <button type="button" class="btn btn-secondary ms-2" (click)="cancelForm()">Cancel</button>
      </form>
    </div>
  </div>
</div>
